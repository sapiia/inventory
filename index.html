<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory System</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .sidebar-active { @apply bg-purple-700 text-white; }
  </style>
  <style>
    /* Basic dark-mode overrides for elements used in the app */
    .dark body { background: #0b1220; color: #e6eef8; }
    .dark aside { background: linear-gradient(180deg,#111827,#0b1220) !important; }
    .dark main { background: linear-gradient(180deg,#071026,#071226) !important; }
    .dark .bg-white { background-color: #081025 !important; color: #e6eef8 !important; border-color: #122032 !important; box-shadow: 0 6px 24px rgba(0,0,0,0.6) !important; }
    .dark .text-gray-600 { color: #9fb0c8 !important; }
    .dark .text-purple-800 { color: #c7b3ff !important; }
    .dark .bg-gradient-to-br.from-purple-50 { background: linear-gradient(180deg,#071026,#071226) !important; }
    .dark .border-gray-50 { border-color: rgba(255,255,255,0.04) !important; }
    .dark .border { border-color: rgba(255,255,255,0.04) !important; }
    .dark .shadow-lg, .dark .shadow-2xl { box-shadow: 0 6px 30px rgba(0,0,0,0.6) !important; }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="w-64 bg-gradient-to-b from-purple-800 to-purple-900 text-white flex flex-col">
      <div class="p-6 text-center border-b border-purple-700">
        <h1 class="text-2xl font-bold">Inventory System</h1>
      </div>
      <nav class="flex-1 p-4">
        <ul class="space-y-2">
          <li><button id="nav-dashboard" class="w-full text-left py-3 px-4 rounded-lg sidebar-active flex items-center gap-3"><i class="fas fa-home"></i> Dashboard</button></li>
          <li><button id="nav-items" class="w-full text-left py-3 px-4 rounded-lg hover:bg-purple-700 flex items-center gap-3"><i class="fas fa-boxes"></i> Items</button></li>
          <li><button id="nav-transactions" class="w-full text-left py-3 px-4 rounded-lg hover:bg-purple-700 flex items-center gap-3"><i class="fas fa-exchange-alt"></i> Transactions</button></li>
          <li><button id="nav-users" class="w-full text-left py-3 px-4 rounded-lg hover:bg-purple-700 flex items-center gap-3"><i class="fas fa-user"></i> Users</button></li>
          <li><button id="nav-settings" class="w-full text-left py-3 px-4 rounded-lg hover:bg-purple-700 flex items-center gap-3"><i class="fas fa-cog"></i> Settings</button></li>
        </ul>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gradient-to-br from-purple-50 to-blue-50 p-8">
      <!-- Dashboard Page -->
      <div id="page-dashboard" class="space-y-8">
        <h2 class="text-3xl font-bold text-purple-800">Dashboard</h2>
        
        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-purple-600">
            <p class="text-gray-600">Total Inventory Value</p>
            <p class="text-3xl font-bold text-purple-800" id="total-value">$0.00</p>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-blue-600">
            <p class="text-gray-600">Total Items</p>
            <p class="text-3xl font-bold text-blue-800" id="total-items">0</p>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6 border-l-4 border-pink-600">
            <p class="text-gray-600">Low Stock Items</p>
            <p class="text-3xl font-bold text-pink-800" id="low-stock">0</p>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4">Monthly Stock Movement</h3>
            <canvas id="barChart"></canvas>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4">Value by Category</h3>
            <canvas id="pieChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Login Page -->
      <div id="page-login" class="hidden flex items-center justify-center p-6 min-h-[70vh]">
        <div class="w-full max-w-md">
          <div class="bg-white rounded-3xl shadow-2xl p-8 ring-1 ring-purple-100">
            <div class="flex flex-col items-center gap-4 mb-6">
              <div class="w-20 h-20 rounded-xl bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center shadow-lg">
                <svg width="34" height="34" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 12h7v9H3z" fill="rgba(255,255,255,0.9)"/>
                  <path d="M14 3h7v18h-7z" fill="rgba(255,255,255,0.9)" opacity="0.9"/>
                  <path d="M10 7l4 3-4 3V7z" fill="rgba(255,255,255,0.95)"/>
                </svg>
              </div>
              <div class="text-center">
                <h1 class="text-3xl font-extrabold text-purple-800">Inventory System</h1>
                <p class="text-gray-500 mt-1" id="form-title">Sign in to continue</p>
              </div>
            </div>

            <div id="messages" class="mb-5 min-h-[2.5rem]"></div>

            <form id="login-form" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email or Username</label>
                <input type="text" id="login-identifier" placeholder="john@example.com or john_doe" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="login-password" placeholder="••••••••" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>

              <div class="flex items-center justify-between text-sm">
                <label class="flex items-center">
                  <input type="checkbox" id="login-remember" class="mr-2 rounded text-purple-600 focus:ring-purple-500">
                  Remember me
                </label>
                <button type="button" id="forgot-btn" class="text-purple-600 hover:text-purple-800 hover:underline">Forgot password?</button>
              </div>

              <button type="submit"
                      class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium py-3.5 rounded-lg shadow-lg transition duration-200">
                Sign In
              </button>
            </form>

            <form id="register-form" class="space-y-4 hidden">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                <input type="text" id="reg-name" placeholder="John Doe" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" id="reg-email" placeholder="john@example.com" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                <input type="text" id="reg-username" placeholder="john_doe" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Phone (optional)</label>
                <input type="tel" id="reg-phone" placeholder="+1234567890"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                <input type="password" id="reg-password" placeholder="••••••••" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition">
              </div>

              <button type="submit"
                      class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-medium py-3.5 rounded-lg shadow-lg transition duration-200">
                Create Account
              </button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-600">
              <span id="toggle-text">Don't have an account?</span>
              <button type="button" id="toggle-form-btn" class="text-purple-600 font-medium hover:text-purple-800 hover:underline">
                Sign up
              </button>
            </div>

            <div id="forgot-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
              <div class="bg-white rounded-2xl shadow-2xl p-7 w-full max-w-md">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Reset Password</h3>
                <p class="text-gray-600 mb-6">Enter your username/email and new password.</p>

                <form id="forgot-form" class="space-y-4">
                  <input type="text" id="forgot-identifier" placeholder="Username or Email" required
                         class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                  <input type="password" id="forgot-newpass" placeholder="New Password" required
                         class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">

                  <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="forgot-cancel" class="px-5 py-2.5 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Reset</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Users Page (admin-style list) -->
      <div id="page-users" class="hidden space-y-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-3xl font-bold text-purple-800">Members</h2>
            <p class="text-sm text-gray-600">Manage members and admins of the system</p>
          </div>
          <div class="flex items-center gap-3">
            <input id="users-search" type="search" placeholder="Search..." class="px-4 py-2 border rounded-lg w-64" />
            <button id="btn-import-members" class="px-3 py-2 border rounded-lg">Import members</button>
            <button id="btn-export-members" class="px-3 py-2 bg-gray-100 rounded-lg">Export members</button>
            <button id="btn-add-user" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Add new</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-4 overflow-auto">
          <table class="w-full min-w-[900px] table-auto">
            <thead class="bg-gray-50">
              <tr class="text-left text-sm text-gray-600">
                <th class="px-4 py-3">Photo</th>
                <th class="px-4 py-3">Member name</th>
                <th class="px-4 py-3">Mobile</th>
                <th class="px-4 py-3">Email</th>
                <th class="px-4 py-3">Status</th>
                <th class="px-4 py-3">Operation</th>
                <th class="px-4 py-3">Action</th>
              </tr>
            </thead>
            <tbody id="users-table-body"></tbody>
          </table>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="page-settings" class="hidden space-y-8">
        <div class="flex items-center justify-between">
          <h2 class="text-3xl font-bold text-purple-800">Settings</h2>
          <div class="flex items-center gap-3">
            <button id="btn-reset-settings" class="px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50">Reset</button>
            <button id="btn-save-settings" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Settings</button>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Left: Controls -->
          <div class="md:col-span-2 space-y-6">
            <div class="flex items-center justify-between p-4 rounded-lg border border-gray-100 hover:shadow-md transition">
              <div>
                <h3 class="font-semibold text-lg">Dark mode</h3>
                <p class="text-sm text-gray-500">Toggle application dark appearance for comfortable viewing</p>
              </div>
              <div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="toggle-dark" type="checkbox" class="sr-only" />
                  <div class="w-12 h-6 bg-gray-200 rounded-full shadow-inner transition-colors" aria-hidden></div>
                  <span class="absolute left-0 top-0 w-6 h-6 bg-white rounded-full shadow transform transition-transform" style="transform: translateX(0);"></span>
                </label>
              </div>
            </div>

            <div class="flex items-center justify-between p-4 rounded-lg border border-gray-100 hover:shadow-md transition">
              <div>
                <h3 class="font-semibold text-lg">Require Login</h3>
                <p class="text-sm text-gray-500">Only authenticated users can access the system</p>
              </div>
              <div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input id="toggle-auth" type="checkbox" class="sr-only" />
                  <div class="w-12 h-6 bg-gray-200 rounded-full shadow-inner transition-colors" aria-hidden></div>
                  <span class="absolute left-0 top-0 w-6 h-6 bg-white rounded-full shadow transform transition-transform" style="transform: translateX(0);"></span>
                </label>
              </div>
            </div>

            <div class="p-4 rounded-lg border border-gray-100">
              <h3 class="font-semibold text-lg">About</h3>
              <p class="text-sm text-gray-500 mt-2">Configure system-wide settings like appearance and authentication. Changes auto-save, use Save to ensure persistence or Reset to restore defaults.</p>
            </div>
          </div>

          <!-- Right: Overview & Actions -->
          <div class="space-y-4">
            <div class="bg-gradient-to-br from-purple-50 to-white p-4 rounded-lg shadow-sm border border-purple-50">
              <p class="text-sm text-gray-600">Total Items</p>
              <p id="settings-total-items" class="text-3xl font-bold text-purple-700 mt-2">0</p>
            </div>

            <div class="bg-gradient-to-br from-blue-50 to-white p-4 rounded-lg shadow-sm border border-blue-50">
              <p class="text-sm text-gray-600">Low Stock (&lt;10)</p>
              <p id="settings-low-stock" class="text-3xl font-bold text-blue-700 mt-2">0</p>
            </div>

            <div class="p-4 rounded-lg border border-gray-100 bg-white">
              <p class="text-sm text-gray-600 mb-2">Export Reports</p>
              <div class="flex gap-2">
                <button id="export-daily" class="flex-1 px-4 py-3 bg-purple-600 text-white rounded-lg shadow">Export Daily CSV</button>
                <button id="export-monthly" class="flex-1 px-4 py-3 border rounded-lg">Export Monthly CSV</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Items Page -->
      <div id="page-items" class="hidden space-y-8">
        <div class="flex justify-between items-center">
          <h2 class="text-3xl font-bold text-purple-800">Items Management</h2>
          <button id="add-item-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center gap-2"><i class="fas fa-plus"></i> Add Item</button>
        </div>
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-purple-100">
              <tr>
                <th class="px-6 py-4 text-left">ID</th>
                <th class="px-6 py-4 text-left">Name</th>
                <th class="px-6 py-4 text-left">Category</th>
                <th class="px-6 py-4 text-left">Quantity</th>
                <th class="px-6 py-4 text-left">Price</th>
                <th class="px-6 py-4 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="items-table-body"></tbody>
          </table>
        </div>
      </div>


    </main>
  </div>

  <!-- Modal for Add/Edit Item -->
  <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
      <h3 id="modal-title" class="text-2xl font-bold mb-6">Add New Item</h3>
      <form id="item-form">
        <input type="hidden" id="edit-id">
        <div class="space-y-4">
          <input type="text" id="item-name" placeholder="Item Name" required class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-purple-600">
          <input type="text" id="item-category" placeholder="Category" required class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-purple-600">
          <input type="number" id="item-quantity" placeholder="Quantity" min="0" required class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-purple-600">
          <input type="number" step="0.01" id="item-price" placeholder="Price per unit" min="0" required class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:border-purple-600">
        </div>
        <div class="flex justify-end gap-4 mt-8">
          <button type="button" id="modal-cancel" class="px-6 py-3 border rounded-lg hover:bg-gray-100">Cancel</button>
          <button type="submit" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">Save</button>
        </div>
      </form>
    </div>
  </div>

    <!-- Modal Add/Edit User -->
    <div id="user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg">
        <h3 id="user-modal-title" class="text-2xl font-bold mb-4">Add Member</h3>
        <form id="user-form">
          <input type="hidden" id="user-id">
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="text-sm text-gray-600">Photo</label>
              <div class="flex items-center gap-3 mt-2">
                <img id="user-pic-preview" src="../assets/images/default-avatar.png" class="w-16 h-16 rounded-md object-cover bg-gray-100" />
                <input id="user-pic-input" type="file" accept="image/*" />
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-600">Name</label>
              <input id="user-name" class="w-full px-3 py-2 border rounded-lg" required />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="text-sm text-gray-600">Mobile</label>
                <input id="user-mobile" class="w-full px-3 py-2 border rounded-lg" />
              </div>
              <div>
                <label class="text-sm text-gray-600">Email</label>
                <input id="user-email" type="email" class="w-full px-3 py-2 border rounded-lg" />
              </div>
            </div>
            <div>
              <label class="text-sm text-gray-600">Status</label>
              <select id="user-status" class="w-full px-3 py-2 border rounded-lg">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div class="flex justify-end gap-3 mt-4">
            <button type="button" id="user-cancel" class="px-4 py-2 border rounded-lg">Cancel</button>
            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Hidden import input -->
    <input id="import-members-input" type="file" accept=".csv,text/csv" class="hidden" />

  <script>
    // Data storage
    let items = JSON.parse(localStorage.getItem('inventoryItems')) || [];
    let nextId = items.length ? Math.max(...items.map(i => i.id)) + 1 : 1;

    // Charts
    let barChart, pieChart;

    // Navigation
    document.getElementById('nav-dashboard').addEventListener('click', () => showPage('dashboard'));
    document.getElementById('nav-items').addEventListener('click', () => showPage('items'));
    document.getElementById('nav-transactions').addEventListener('click', () => {
      window.location.href = 'pages/transection.html';
    });
    document.getElementById('nav-users').addEventListener('click', () => showPage('users'));
    document.getElementById('nav-settings').addEventListener('click', () => showPage('settings'));

    function showPage(page) {
      document.querySelectorAll('[id^="page-"]').forEach(el => el.classList.add('hidden'));
      document.getElementById(`page-${page}`).classList.remove('hidden');

      document.querySelectorAll('aside button').forEach(btn => btn.classList.remove('sidebar-active'));
      const navBtn = document.getElementById(`nav-${page}`);
      if(navBtn) navBtn.classList.add('sidebar-active');

      if (page === 'dashboard') updateDashboard();
      if (page === 'items') renderItemsTable();
      if (page === 'users') renderUsersPage();
      if (page === 'settings') renderSettingsPage();
    }

    // CRUD for Items
    document.getElementById('add-item-btn').addEventListener('click', openAddModal);
    function openAddModal() {
      document.getElementById('modal-title').textContent = 'Add New Item';
      document.getElementById('item-form').reset();
      document.getElementById('edit-id').value = '';
      document.getElementById('item-modal').classList.remove('hidden');
    }

    document.getElementById('modal-cancel').addEventListener('click', () => {
      document.getElementById('item-modal').classList.add('hidden');
    });

    document.getElementById('item-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('edit-id').value || nextId++;
      const name = document.getElementById('item-name').value;
      const category = document.getElementById('item-category').value;
      const quantity = parseInt(document.getElementById('item-quantity').value);
      const price = parseFloat(document.getElementById('item-price').value);

      if (id > items.length && items.some(i => i.id === id)) id = nextId++; // safety

      const existingIndex = items.findIndex(i => i.id === parseInt(id));
      if (existingIndex > -1) {
        items[existingIndex] = {id: parseInt(id), name, category, quantity, price};
      } else {
        items.push({id, name, category, quantity, price});
      }

      saveData();
      document.getElementById('item-modal').classList.add('hidden');
      renderItemsTable();
      updateDashboard();
    });

    function editItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;
      document.getElementById('modal-title').textContent = 'Edit Item';
      document.getElementById('edit-id').value = item.id;
      document.getElementById('item-name').value = item.name;
      document.getElementById('item-category').value = item.category;
      document.getElementById('item-quantity').value = item.quantity;
      document.getElementById('item-price').value = item.price;
      document.getElementById('item-modal').classList.remove('hidden');
    }

    function deleteItem(id) {
      if (!confirm('Delete this item?')) return;
      items = items.filter(i => i.id !== id);
      saveData();
      renderItemsTable();
      updateDashboard();
    }

    // Rendering
    function renderItemsTable() {
      const tbody = document.getElementById('items-table-body');
      tbody.innerHTML = '';
      items.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-purple-50';
        tr.innerHTML = `
          <td class="px-6 py-4">${item.id}</td>
          <td class="px-6 py-4">${item.name}</td>
          <td class="px-6 py-4">${item.category}</td>
          <td class="px-6 py-4">${item.quantity}</td>
          <td class="px-6 py-4">$${item.price.toFixed(2)}</td>
          <td class="px-6 py-4">
            <button onclick="editItem(${item.id})" class="text-blue-600 hover:underline mr-4">Edit</button>
            <button onclick="deleteItem(${item.id})" class="text-red-600 hover:underline">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Dashboard Update
    function updateDashboard() {
      const totalValue = items.reduce((sum, i) => sum + i.quantity * i.price, 0);
      const totalItems = items.reduce((sum, i) => sum + i.quantity, 0);
      const lowStock = items.filter(i => i.quantity < 10).length;

      document.getElementById('total-value').textContent = `$${totalValue.toFixed(2)}`;
      document.getElementById('total-items').textContent = totalItems;
      document.getElementById('low-stock').textContent = lowStock;

      // Bar Chart - Monthly movement (simulated with last 6 months)
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
      const inflows = months.map(() => Math.floor(Math.random() * 500));
      const outflows = months.map(() => Math.floor(Math.random() * 400));

      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById('barChart'), {
        type: 'bar',
        data: {
          labels: months,
          datasets: [
            { label: 'Stock In', data: inflows, backgroundColor: '#9333ea' },
            { label: 'Stock Out', data: outflows, backgroundColor: '#ec4899' }
          ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });

      // Pie Chart - Category value
      const categoryData = {};
      items.forEach(i => {
        categoryData[i.category] = (categoryData[i.category] || 0) + i.quantity * i.price;
      });
      const labels = Object.keys(categoryData);
      const data = Object.values(categoryData);

      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: {
          labels: labels.length ? labels : ['No Data'],
          datasets: [{ data: data.length ? data : [1], backgroundColor: ['#9333ea', '#a855f7', '#c084fc', '#ddd6fe', '#f3e8ff'] }]
        },
        options: { responsive: true }
      });
    }

    function saveData() {
      localStorage.setItem('inventoryItems', JSON.stringify(items));
    }

    /* ----------------- Users & Settings features ----------------- */
    function loadProfile(){
      try{return JSON.parse(localStorage.getItem('inventory_user_profile')) || {name:'',picture:''}}catch(e){return {name:'',picture:''}}
    }
    function saveProfile(p){ localStorage.setItem('inventory_user_profile', JSON.stringify(p)); }

    // ----- Users management (members table) -----
    function loadMembers(){ try{ return JSON.parse(localStorage.getItem('inventory_users')) || []; }catch(e){return []} }
    function saveMembers(list){ localStorage.setItem('inventory_users', JSON.stringify(list)); }

    function renderUsersPage(){
      const tbody = document.getElementById('users-table-body');
      const members = loadMembers();
      const q = (document.getElementById('users-search') && document.getElementById('users-search').value || '').toLowerCase();
      tbody.innerHTML = '';
      members.filter(m=> !q || (m.name && m.name.toLowerCase().includes(q)) || (m.email && m.email.toLowerCase().includes(q)) || (m.mobile && m.mobile.toLowerCase().includes(q))).forEach(m=>{
        const tr = document.createElement('tr');
        tr.className = 'border-b';

        // Photo
        const tdPhoto = document.createElement('td'); tdPhoto.className = 'px-4 py-3';
        const img = document.createElement('img'); img.src = m.picture || '../assets/images/default-avatar.png'; img.className = 'w-12 h-12 rounded-md object-cover'; tdPhoto.appendChild(img);

        // Name
        const tdName = document.createElement('td'); tdName.className = 'px-4 py-3 font-medium'; tdName.textContent = m.name || '';

        // Mobile
        const tdMobile = document.createElement('td'); tdMobile.className = 'px-4 py-3'; tdMobile.textContent = m.mobile || '';

        // Email
        const tdEmail = document.createElement('td'); tdEmail.className = 'px-4 py-3'; tdEmail.textContent = m.email || '';

        // Status
        const tdStatus = document.createElement('td'); tdStatus.className = 'px-4 py-3';
        const spanStatus = document.createElement('span'); spanStatus.className = `px-3 py-1 rounded-full text-sm ${m.status==='Active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`; spanStatus.textContent = m.status || 'Active'; tdStatus.appendChild(spanStatus);

        // Operation (Make admin placeholder)
        const tdOp = document.createElement('td'); tdOp.className = 'px-4 py-3';
        if(m.status === 'Active'){
          const btnOp = document.createElement('button'); btnOp.className = 'px-3 py-1 bg-purple-600 text-white rounded-lg text-sm'; btnOp.textContent = 'Make admin';
          tdOp.appendChild(btnOp);
        } else {
          tdOp.textContent = '-';
        }

        // Actions (icons)
        const tdAction = document.createElement('td'); tdAction.className = 'px-4 py-3 flex items-center gap-2';

        const btnEdit = document.createElement('button'); btnEdit.title = 'Edit'; btnEdit.className = 'p-2 rounded-md hover:bg-gray-100'; btnEdit.innerHTML = '<i class="fas fa-pen text-blue-600"></i>';
        btnEdit.addEventListener('click', ()=> editMember(m.id));

        const btnDelete = document.createElement('button'); btnDelete.title = 'Delete'; btnDelete.className = 'p-2 rounded-md hover:bg-gray-100'; btnDelete.innerHTML = '<i class="fas fa-trash text-red-600"></i>';
        btnDelete.addEventListener('click', ()=> deleteMember(m.id));

        const btnLogin = document.createElement('button'); btnLogin.title = 'Login'; btnLogin.className = 'p-2 rounded-md bg-gray-100'; btnLogin.innerHTML = '<i class="fas fa-sign-in-alt text-gray-700"></i>';
        btnLogin.addEventListener('click', ()=> loginAsMember(m.id));

        tdAction.appendChild(btnEdit);
        tdAction.appendChild(btnDelete);
        tdAction.appendChild(btnLogin);

        tr.appendChild(tdPhoto);
        tr.appendChild(tdName);
        tr.appendChild(tdMobile);
        tr.appendChild(tdEmail);
        tr.appendChild(tdStatus);
        tr.appendChild(tdOp);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    // Search
    document.getElementById('users-search').addEventListener('input', ()=> renderUsersPage());

    // Add new
    document.getElementById('btn-add-user').addEventListener('click', ()=> openMemberModal());

    function openMemberModal(member){
      document.getElementById('user-form').reset();
      document.getElementById('user-id').value = '';
      document.getElementById('user-pic-preview').src = '../assets/images/default-avatar.png';
      document.getElementById('user-modal-title').textContent = member? 'Edit Member':'Add Member';
      if(member){
        document.getElementById('user-id').value = member.id;
        document.getElementById('user-name').value = member.name || '';
        document.getElementById('user-mobile').value = member.mobile || '';
        document.getElementById('user-email').value = member.email || '';
        document.getElementById('user-status').value = member.status || 'Active';
        document.getElementById('user-pic-preview').src = member.picture || '../assets/images/default-avatar.png';
      }
      document.getElementById('user-modal').classList.remove('hidden');
    }

    document.getElementById('user-cancel').addEventListener('click', ()=> document.getElementById('user-modal').classList.add('hidden'));

    // Picture input in modal
    document.getElementById('user-pic-input').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload=()=>{ document.getElementById('user-pic-preview').src = r.result; document.getElementById('user-pic-preview').dataset.pending = r.result; }; r.readAsDataURL(f);
    });

    // Save member
    document.getElementById('user-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const idField = document.getElementById('user-id');
      const id = idField.value || ('u' + Date.now());
      const name = document.getElementById('user-name').value.trim();
      const mobile = document.getElementById('user-mobile').value.trim();
      const email = document.getElementById('user-email').value.trim();
      const status = document.getElementById('user-status').value;
      const picEl = document.getElementById('user-pic-preview');
      const picture = picEl.dataset.pending || picEl.src;
      let members = loadMembers();
      const idx = members.findIndex(m=>m.id === id);
      const obj = {id, name, mobile, email, status, picture};
      if(idx>-1) members[idx]=obj; else members.push(obj);
      saveMembers(members);
      document.getElementById('user-modal').classList.add('hidden');
      renderUsersPage();
    });

    // Edit/Delete/Login actions
    window.editMember = function(id){ const members = loadMembers(); const m = members.find(x=>x.id===id); if(m) openMemberModal(m); };
    window.deleteMember = function(id){ if(!confirm('Delete member?')) return; let members = loadMembers(); members = members.filter(m=>m.id!==id); saveMembers(members); renderUsersPage(); };
    window.loginAsMember = function(id){ const members = loadMembers(); const m = members.find(x=>x.id===id); if(!m){ alert('Member not found'); return; } auth.login({username: m.name||m.email||m.id, password:'dummy'}, true).then(res=>{ if(res.ok) { alert('Logged in as '+(m.name||m.email)); location.reload(); } else alert('Login failed'); }); };

    // Import/Export members
    document.getElementById('btn-export-members').addEventListener('click', ()=>{
      const members = loadMembers(); const headers = ['id','name','mobile','email','status']; const lines = [headers.join(',')]; members.forEach(m=> lines.push([m.id,`"${(m.name||'').replace(/"/g,'""')}`,`"${(m.mobile||'').replace(/"/g,'""')}`,`"${(m.email||'').replace(/"/g,'""')}`, m.status||'Active'].join(',')) ); const csv = lines.join('\n'); const name = `members-${new Date().toISOString().slice(0,10)}.csv`; const blob = new Blob([csv],{type:'text/csv'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('btn-import-members').addEventListener('click', ()=> document.getElementById('import-members-input').click());
    document.getElementById('import-members-input').addEventListener('change', (e)=>{
      const f = e.target.files && e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const text = r.result; const lines = text.split(/\r?\n/).filter(Boolean); const hdr = lines.shift().split(/,\s*/).map(s=>s.replace(/"/g,'')); const members = loadMembers(); lines.forEach(l=>{ const cols = l.split(/,\s*/); const id = cols[0] || ('u'+Date.now()+Math.random()); const name = (cols[1]||'').replace(/"/g,''); const mobile = (cols[2]||'').replace(/"/g,''); const email = (cols[3]||'').replace(/"/g,''); const status = (cols[4]||'Active'); members.push({id,name,mobile,email,status,picture:'../assets/images/default-avatar.png'}); }); saveMembers(members); renderUsersPage(); alert('Import complete'); }; r.readAsText(f);
    });


    // Settings
    function loadSettings(){ try{return JSON.parse(localStorage.getItem('inventory_settings')) || {dark:false,requireAuth:true}}catch(e){return {dark:false,requireAuth:true}} }
    function saveSettings(s){ localStorage.setItem('inventory_settings', JSON.stringify(s)); }

    function renderSettingsPage(){
      const s = loadSettings();
      const darkEl = document.getElementById('toggle-dark');
      const authEl = document.getElementById('toggle-auth');
      darkEl.checked = !!s.dark;
      authEl.checked = s.requireAuth !== false;
      // update visual switches
      setSwitchVisual(darkEl);
      setSwitchVisual(authEl);
      // stock overview
      document.getElementById('settings-total-items').textContent = items.reduce((sum,i)=>sum + i.quantity,0);
      document.getElementById('settings-low-stock').textContent = items.filter(i=>i.quantity<10).length;
    }

    function setSwitchVisual(chk){
      if(!chk) return;
      const track = chk.nextElementSibling; // the track div
      const knob = track ? track.nextElementSibling : null; // the knob span
      if(chk.checked){
        if(track) track.classList.remove('bg-gray-200'); track && track.classList.add('bg-purple-600');
        if(knob) knob.style.transform = 'translateX(160%)';
      } else {
        if(track) track.classList.remove('bg-purple-600'); track && track.classList.add('bg-gray-200');
        if(knob) knob.style.transform = 'translateX(0)';
      }
    }

    document.getElementById('toggle-dark').addEventListener('change', (e)=>{
      const s = loadSettings(); s.dark = !!e.target.checked; saveSettings(s); applyDarkMode(s.dark);
      setSwitchVisual(e.target);
    });

    document.getElementById('toggle-auth').addEventListener('change', (e)=>{
      const s = loadSettings(); s.requireAuth = !!e.target.checked; saveSettings(s);
      setSwitchVisual(e.target);
    });

    // Save / Reset buttons and toast
    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 right-6 bg-black text-white px-4 py-2 rounded-lg shadow-lg z-50';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity = '0'; t.style.transform = 'translateY(10px)'; setTimeout(()=>t.remove(),300); }, 1800);
    }

    document.getElementById('btn-save-settings').addEventListener('click', ()=>{
      const s = loadSettings();
      s.dark = !!document.getElementById('toggle-dark').checked;
      s.requireAuth = !!document.getElementById('toggle-auth').checked;
      saveSettings(s);
      applyDarkMode(s.dark);
      showToast('Settings saved');
    });

    document.getElementById('btn-reset-settings').addEventListener('click', ()=>{
      if(!confirm('Reset settings to defaults?')) return;
      const defaults = {dark:false, requireAuth:true};
      saveSettings(defaults);
      renderSettingsPage();
      applyDarkMode(false);
      showToast('Settings reset to defaults');
    });

    function applyDarkMode(enabled){
      if(enabled){ document.documentElement.classList.add('dark'); document.body.classList.add('bg-gray-900'); }
      else { document.documentElement.classList.remove('dark'); document.body.classList.remove('bg-gray-900'); }
    }

    // Export CSV helpers
    function itemsToCSV(rows){
      const headers = ['id','name','category','quantity','price'];
      const lines = [headers.join(',')];
      rows.forEach(r=> lines.push([r.id,`"${r.name.replace(/"/g,'""')}` , r.category, r.quantity, r.price].join(',')));
      return lines.join('\n');
    }

    function downloadCSV(filename, content){
      const blob = new Blob([content], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    document.getElementById('export-daily').addEventListener('click', ()=>{
      const csv = itemsToCSV(items);
      const name = `inventory-daily-${new Date().toISOString().slice(0,10)}.csv`;
      downloadCSV(name, csv);
    });
    document.getElementById('export-monthly').addEventListener('click', ()=>{
      const csv = itemsToCSV(items);
      const d = new Date(); const name = `inventory-monthly-${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}.csv`;
      downloadCSV(name, csv);
    });

    // Enforce require-login on navigation and initialize dark mode
    const initialSettings = loadSettings(); applyDarkMode(initialSettings.dark);

    // --------- Login / Register logic (moved from pages/login.html) ---------
    const showMessage = (text, type = 'info') => {
      const el = document.getElementById('messages');
      if(!el) return;
      const bg = type === 'error' ? 'bg-red-100 text-red-700' :
                 type === 'success' ? 'bg-green-100 text-green-700' :
                 'bg-blue-50 text-blue-700';
      el.innerHTML = `<div class="p-3 rounded-lg text-sm ${bg}">${text}</div>`;
      setTimeout(() => el.innerHTML = '', 4500);
    };

    const loadUsers = () => { try { return JSON.parse(localStorage.getItem('inventory_users')) || []; } catch { return []; } };
    const saveUsers = (users) => { localStorage.setItem('inventory_users', JSON.stringify(users)); };

    // Form toggle
    const loginFormEl = document.getElementById('login-form');
    const registerFormEl = document.getElementById('register-form');
    const toggleBtn = document.getElementById('toggle-form-btn');
    const toggleText = document.getElementById('toggle-text');
    const formTitle = document.getElementById('form-title');

    function switchToRegister(){
      loginFormEl.classList.add('hidden'); registerFormEl.classList.remove('hidden');
      toggleText.textContent = 'Already have an account?'; toggleBtn.textContent = 'Sign in'; formTitle.textContent = 'Create your account';
    }
    function switchToLogin(){
      registerFormEl.classList.add('hidden'); loginFormEl.classList.remove('hidden');
      toggleText.textContent = "Don't have an account?"; toggleBtn.textContent = 'Sign up'; formTitle.textContent = 'Sign in to continue';
    }

    if(toggleBtn) toggleBtn.addEventListener('click', ()=>{ if(loginFormEl.classList.contains('hidden')) switchToLogin(); else switchToRegister(); });

    // LOGIN
    if(loginFormEl) loginFormEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      const identifier = document.getElementById('login-identifier').value.trim();
      const password = document.getElementById('login-password').value;
      const remember = document.getElementById('login-remember').checked;
      if(!identifier || !password){ showMessage('Please fill in all fields','error'); return; }
      const users = loadUsers();
      const user = users.find(u => (u.email?.toLowerCase()===identifier.toLowerCase()) || (u.username?.toLowerCase()===identifier.toLowerCase()));
      if(!user || user.password !== password){ showMessage('Invalid username/email or password','error'); return; }
      const session = { username: user.username, name: user.name, email: user.email, loginTime: Date.now() };
      const token = btoa(JSON.stringify(session) + '::' + Date.now());
      const storage = remember ? localStorage : sessionStorage;
      storage.setItem('inventory_user', JSON.stringify(session));
      storage.setItem('inventory_token', token);
      showMessage('Login successful! Redirecting...','success');
      setTimeout(()=> showPage('dashboard'), 800);
    });

    // REGISTER
    if(registerFormEl) registerFormEl.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = document.getElementById('reg-name').value.trim();
      const email = document.getElementById('reg-email').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const phone = document.getElementById('reg-phone').value.trim();
      const password = document.getElementById('reg-password').value;
      if(!name || !email || !username || !password){ showMessage('Please fill all required fields','error'); return; }
      const users = loadUsers();
      if(users.some(u => u.username.toLowerCase()===username.toLowerCase())){ showMessage('Username already taken','error'); return; }
      if(users.some(u => u.email?.toLowerCase()===email.toLowerCase())){ showMessage('Email already registered','error'); return; }
      const newUser = { name, email, username, phone: phone||null, password, createdAt: new Date().toISOString() };
      users.push(newUser); saveUsers(users);
      showMessage('Account created successfully! You can now sign in.','success');
      document.getElementById('login-identifier').value = username; switchToLogin();
    });

    // FORGOT PASSWORD
    const forgotModal = document.getElementById('forgot-modal');
    const forgotBtn = document.getElementById('forgot-btn');
    if(forgotBtn) forgotBtn.addEventListener('click', ()=> forgotModal.classList.remove('hidden'));
    const forgotCancel = document.getElementById('forgot-cancel');
    if(forgotCancel) forgotCancel.addEventListener('click', ()=> forgotModal.classList.add('hidden'));
    const forgotForm = document.getElementById('forgot-form');
    if(forgotForm) forgotForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const identifier = document.getElementById('forgot-identifier').value.trim();
      const newPassword = document.getElementById('forgot-newpass').value;
      if(!identifier || !newPassword){ showMessage('Please fill all fields','error'); return; }
      const users = loadUsers();
      const idx = users.findIndex(u => u.username.toLowerCase()===identifier.toLowerCase() || u.email?.toLowerCase()===identifier.toLowerCase());
      if(idx===-1){ showMessage('No account found with that username/email','error'); return; }
      users[idx].password = newPassword; saveUsers(users);
      showMessage('Password has been reset! You can now login.','success');
      forgotModal.classList.add('hidden');
      document.getElementById('login-identifier').value = identifier; switchToLogin();
    });

    // Auto-redirect if already logged in
    if(localStorage.getItem('inventory_token') || sessionStorage.getItem('inventory_token')){
      showPage('dashboard');
    }

    // Override showPage to route to the internal login page when needed
    const originalShowPage = showPage;
    window.showPage = function(page){
      const s = loadSettings();
      if(s.requireAuth && window.auth && auth.isAuthenticated && !auth.isAuthenticated()){
        // show internal login page
        originalShowPage('login');
        return;
      }
      originalShowPage(page);
    };

    // Handle hash navigation
    function handleHashNavigation() {
      const hash = window.location.hash.substring(1);
      if (hash === 'items') {
        showPage('items');
      } else if (hash === 'login') {
        showPage('login');
      } else {
        showPage('dashboard');
      }
    }

    // Listen for hash changes
    window.addEventListener('hashchange', handleHashNavigation);

    // Initial load
    handleHashNavigation();
  </script>
</body>
</html>